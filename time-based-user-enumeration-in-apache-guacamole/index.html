<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="noodp"><title>Time based user enumeration in Apache Guacamole - Raptor Blog</title><meta name=Description content="Post about how an attacker could abuse response times to enumerate valid users in Guacamole"><meta property="og:title" content="Time based user enumeration in Apache Guacamole"><meta property="og:description" content="Post about how an attacker could abuse response times to enumerate valid users in Guacamole"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.anthares101.com/time-based-user-enumeration-in-apache-guacamole/"><meta property="og:image" content="https://blog.anthares101.com/time-based-user-enumeration-in-apache-guacamole/images/banner.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-02-21T00:00:00+00:00"><meta property="article:modified_time" content="2024-02-21T00:00:00+00:00"><meta property="og:site_name" content="Raptor Blog"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.anthares101.com/time-based-user-enumeration-in-apache-guacamole/images/banner.png"><meta name=twitter:title content="Time based user enumeration in Apache Guacamole"><meta name=twitter:description content="Post about how an attacker could abuse response times to enumerate valid users in Guacamole"><meta name=application-name content="Raptor Blog"><meta name=apple-mobile-web-app-title content="Raptor Blog"><meta name=theme-color content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://blog.anthares101.com/time-based-user-enumeration-in-apache-guacamole/><link rel=prev href=https://blog.anthares101.com/how-to-setup-the-flipper-zero-for-wi-fi-attacks/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.1.1/css/all.min.css></noscript><link rel=preload href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css as=style onload='this.onload=null,this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"Time based user enumeration in Apache Guacamole","inLanguage":"en","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/blog.anthares101.com\/time-based-user-enumeration-in-apache-guacamole\/"},"image":["https:\/\/blog.anthares101.com\/banner.png"],"genre":"posts","keywords":"enum, red team, network","wordcount":841,"url":"https:\/\/blog.anthares101.com\/time-based-user-enumeration-in-apache-guacamole\/","datePublished":"2024-02-21T00:00:00+00:00","dateModified":"2024-02-21T00:00:00+00:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"Anthares101"},"description":"Post about how an attacker could abuse response times to enumerate valid users in Guacamole"}</script><script defer src=https://static.cloudflareinsights.com/beacon.min.js data-cf-beacon='{"token": "0eec0c6a58a84bcea4130feee244a950"}'></script></head><body data-header-desktop=fixed data-header-mobile=auto><script type=text/javascript>(window.localStorage&&localStorage.getItem("theme")?localStorage.getItem("theme")==="dark":"dark"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"dark"==="dark")&&document.body.setAttribute("theme","dark")</script><div id=mask></div><div class=wrapper><header class=desktop id=header-desktop><div class=header-wrapper><div class=header-title><a href=/ title="Raptor Blog"><span class=header-title-pre><i class='fa-solid fa-flag'></i></span>Raptor Blog</a></div><div class=menu><div class=menu-inner><a class=menu-item href=/posts/>Posts </a><a class=menu-item href=/tags/>Tags </a><a class=menu-item href=/categories/>Categories </a><a class=menu-item href=https://github.com/anthares101/raptor-blog title="Check the code!" rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i> </a><span class="menu-item delimiter"></span><span class="menu-item search" id=search-desktop>
<input type=text placeholder="Search titles or contents..." id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-desktop><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span>
</span><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></div></header><header class=mobile id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title="Raptor Blog"><span class=header-title-pre><i class='fa-solid fa-flag'></i></span>Raptor Blog</a></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><div class=menu id=menu-mobile><div class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder="Search titles or contents..." id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=Search><i class="fas fa-search fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=Clear><i class="fas fa-times-circle fa-fw" aria-hidden=true></i></a>
<span class="search-button search-loading" id=search-loading-mobile><i class="fas fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>Cancel</a></div><a class=menu-item href=/posts/ title>Posts</a><a class=menu-item href=/tags/ title>Tags</a><a class=menu-item href=/categories/ title>Categories</a><a class=menu-item href=https://github.com/anthares101/raptor-blog title="Check the code!" rel="noopener noreffer" target=_blank><i class='fab fa-github fa-fw' aria-hidden=true></i></a><a href=javascript:void(0); class="menu-item theme-switch" title="Switch Theme">
<i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><main class=main><div class=container><div class=toc id=toc-auto><h2 class=toc-title>Contents</h2><div class=toc-content id=toc-content-auto></div></div><article class="page single"><h1 class="single-title animate__animated animate__flipInX">Time based user enumeration in Apache Guacamole</h1><div class=post-meta><div class=post-meta-line><span class=post-author><a href=/posts/ title=Author rel=author class=author><i class="fas fa-user-circle fa-fw" aria-hidden=true></i>Anthares101</a></span>&nbsp;<span class=post-category>included in <a href=/categories/offensive-cybersecurity/><i class="far fa-folder fa-fw" aria-hidden=true></i>Offensive Cybersecurity</a></span></div><div class=post-meta-line><i class="far fa-calendar-alt fa-fw" aria-hidden=true></i>&nbsp;<time datetime=2024-02-21>2024-02-21</time>&nbsp;<i class="fas fa-pencil-alt fa-fw" aria-hidden=true></i>&nbsp;841 words&nbsp;
<i class="far fa-clock fa-fw" aria-hidden=true></i>&nbsp;4 minutes&nbsp;</div></div><div class=featured-image><img class=lazyload src=/svg/loading.min.svg data-src=/time-based-user-enumeration-in-apache-guacamole/images/banner.png data-srcset="/time-based-user-enumeration-in-apache-guacamole/images/banner.png, /time-based-user-enumeration-in-apache-guacamole/images/banner.png 1.5x, /time-based-user-enumeration-in-apache-guacamole/images/banner.png 2x" data-sizes=auto alt=/time-based-user-enumeration-in-apache-guacamole/images/banner.png title="Post about how an attacker could abuse response times to enumerate valid users in Guacamole" width=1024 height=1008></div><div class="details toc" id=toc-static data-kept=true><div class="details-summary toc-title"><span>Contents</span>
<span><i class="details-icon fas fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#setup>Setup</a></li><li><a href=#the-idea>The idea</a></li><li><a href=#exploit-time>Exploit time!</a></li><li><a href=#any-fix>Any fix?</a></li></ul></nav></div></div><div class=content id=content><h1 id=time-based-user-enumeration-in-apache-guacamole>Time based user enumeration in Apache Guacamole</h1><p>Is this even a thing? Well, according to OWASP it is! And to my surprise it could work extremelly well given the right scenario. Remember that performing any of the attacks explained in this post to networks without previous consent is illegal, this post information is for educational purposes only.</p><h2 id=setup>Setup</h2><p>Let&rsquo;s prepare the environment, I deployed a Tomcat Guacamole instance (v1.5.4) and generated some users. If you want to replicate a similar lab, you can do it with <a href=https://github.com/boschkundendienst/guacamole-docker-compose target=_blank rel="noopener noreffer">this repo and Docker</a>.</p><img src=images/guacamole-users.png alt="Image showing the different users created in Guacamole"><h2 id=the-idea>The idea</h2><p>Now that we have something to play with, is time to see why this vector is going to work. I decided to use Guacamole for the PoC because is a pretty known software and the way the login form works when using the <a href=https://github.com/apache/guacamole-client/blob/1.5.4/extensions/guacamole-auth-jdbc/modules/guacamole-auth-jdbc-base/src/main/java/org/apache/guacamole/auth/jdbc/user/UserService.java#L370-L394 target=_blank rel="noopener noreffer">JDBC driver</a> is the perfect scenario:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>public</span> <span class=n>ModeledAuthenticatedUser</span> <span class=n>retrieveAuthenticatedUser</span><span class=p>(</span><span class=n>AuthenticationProvider</span> <span class=n>authenticationProvider</span><span class=p>,</span> <span class=n>Credentials</span> <span class=n>credentials</span><span class=p>)</span> <span class=n>throws</span> <span class=n>GuacamoleException</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Get</span> <span class=n>username</span> <span class=ow>and</span> <span class=n>password</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>username</span> <span class=o>=</span> <span class=n>credentials</span><span class=o>.</span><span class=n>getUsername</span><span class=p>();</span>
</span></span><span class=line><span class=cl>    <span class=n>String</span> <span class=n>password</span> <span class=o>=</span> <span class=n>credentials</span><span class=o>.</span><span class=n>getPassword</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Retrieve</span> <span class=n>corresponding</span> <span class=n>user</span> <span class=n>model</span><span class=p>,</span> <span class=k>if</span> <span class=n>such</span> <span class=n>a</span> <span class=n>user</span> <span class=n>exists</span>
</span></span><span class=line><span class=cl>    <span class=n>UserModel</span> <span class=n>userModel</span> <span class=o>=</span> <span class=n>userMapper</span><span class=o>.</span><span class=n>selectOne</span><span class=p>(</span><span class=n>username</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>userModel</span> <span class=o>==</span> <span class=n>null</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Verify</span> <span class=n>provided</span> <span class=n>password</span> <span class=ow>is</span> <span class=n>correct</span>
</span></span><span class=line><span class=cl>    <span class=n>byte</span><span class=p>[]</span> <span class=nb>hash</span> <span class=o>=</span> <span class=n>encryptionService</span><span class=o>.</span><span class=n>createPasswordHash</span><span class=p>(</span><span class=n>password</span><span class=p>,</span> <span class=n>userModel</span><span class=o>.</span><span class=n>getPasswordSalt</span><span class=p>());</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=err>!</span><span class=n>Arrays</span><span class=o>.</span><span class=n>equals</span><span class=p>(</span><span class=nb>hash</span><span class=p>,</span> <span class=n>userModel</span><span class=o>.</span><span class=n>getPasswordHash</span><span class=p>()))</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=n>null</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Create</span> <span class=n>corresponding</span> <span class=n>user</span> <span class=nb>object</span><span class=p>,</span> <span class=nb>set</span> <span class=n>up</span> <span class=n>cyclic</span> <span class=n>reference</span>
</span></span><span class=line><span class=cl>    <span class=n>ModeledUser</span> <span class=n>user</span> <span class=o>=</span> <span class=n>getObjectInstance</span><span class=p>(</span><span class=n>null</span><span class=p>,</span> <span class=n>userModel</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>user</span><span class=o>.</span><span class=n>setCurrentUser</span><span class=p>(</span><span class=n>new</span> <span class=n>ModeledAuthenticatedUser</span><span class=p>(</span><span class=n>authenticationProvider</span><span class=p>,</span> <span class=n>user</span><span class=p>,</span> <span class=n>credentials</span><span class=p>));</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=o>//</span> <span class=n>Return</span> <span class=n>now</span><span class=o>-</span><span class=n>authenticated</span> <span class=n>user</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>user</span><span class=o>.</span><span class=n>getCurrentUser</span><span class=p>();</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>By reviewing the code published on GitHub it is possible to observe that, during the login process, the calculation of the hash of the password sent in the form is only performed if the user entered is valid. This different behavior of the application depending on the user entered would allow an attacker to send a password with many characters to cause a difference in server response times when a user is or is not valid.</p><p>The idea would be as follows:</p><ul><li>First, several requests are made to obtain the server response time using an incorrect user (a random value, for example) and any password.</li><li>Then, the average response time is calculated by eliminating from the sample possible outliers, i.e. response times that are out of the ordinary due to the network or any other disturbance. The idea is to make the mean as robust as possible.</li><li>Once the previous average is obtained, which will be called baseline from now on, proceed to take the username whose existence is to be checked and perform again the process described above to calculate the baseline average. Importantly, the password used in this case must have many characters to force a significant time difference in server responses.</li><li>Finally, the baseline and the new mean obtained must be taken and compared. If the new mean is higher than the base mean, the user entered exists in the database because the password hash calculation has been performed. In case the values of the averages are very similar, sometimes the new average is lower, the entered user is not valid.</li></ul><h2 id=exploit-time>Exploit time!</h2><p>In order to achieve everything I commented before, I created <a href=https://github.com/anthares101/ethical-hacking/blob/master/exploits/guacatime.py target=_blank rel="noopener noreffer">a little Python script</a> that should be able to perform the exploitation process. It can be seen how it is possible to discern between a valid and an invalid user by analyzing the response times of the application.</p><img src=images/guacamole-script-results.png alt="Image showing the result of the Python script"><p>Keep in mind that this is a local Guacamole intance, the network is not a problem. For targets accross the network you may need to play with some of the script parameters in order to get reliable results.</p><p><strong>NOTE: As you may already have guessed, this technique is not only effective against Apache Guacamole. Any software using a similar login system is vulnerable.</strong></p><h2 id=any-fix>Any fix?</h2><p>A logical question here is, how could I avoid this? An interesting solution is to add a &ldquo;dummy&rdquo; hashing operation even if the user does not exist, which should avoid the compute difference between a valid and a non valid user. The thing is that even with that sort of fix, the connection to the database itself could mean a similar vector based on time (More complex though).</p><p>Putting our &ldquo;dummy&rdquo; hash into the database forcing a call to it could be enough to mask the compute discrepancies but, even then, the database may experiment little differences in response times for values that are often requested so an attack variant could still work.</p><p align=center><img src=images/databases-image.png width=200 alt="Image showing a representation of databases"></p><p>You may be thinking that, since the exploit abuse a long password to increase the server response window when a user exists, a limitation in the submited password could be a solution. The problem is again the same, the database response times.</p><p>The non resilient nature of the possible fixes is what make this kind of vulnerabilities hard to circumvent. After dicussing the problem, the Guacamole maintainers decided the hardening change they plan to introduce in the future Guacamole version to add brute force protection should be enough to mitigate this technique. Until then, systems like Fail2ban shoud do the work.</p></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span>Updated on 2024-02-21</span></div></div><div class=post-info-line><div class=post-info-md><span><a class=link-to-markdown href=/time-based-user-enumeration-in-apache-guacamole/index.md target=_blank>Read Markdown</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="Share on Twitter" data-sharer=twitter data-url=https://blog.anthares101.com/time-based-user-enumeration-in-apache-guacamole/ data-title="Time based user enumeration in Apache Guacamole" data-via=@Anthares101 data-hashtags="enum,red team,network"><i class="fab fa-twitter fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Facebook" data-sharer=facebook data-url=https://blog.anthares101.com/time-based-user-enumeration-in-apache-guacamole/ data-hashtag=enum><i class="fab fa-facebook-square fa-fw" aria-hidden=true></i></a><a href=javascript:void(0); title="Share on Linkedin" data-sharer=linkedin data-url=https://blog.anthares101.com/time-based-user-enumeration-in-apache-guacamole/><i class="fab fa-linkedin fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fas fa-tags fa-fw" aria-hidden=true></i>&nbsp;<a href=/tags/enum/>enum</a>,&nbsp;<a href=/tags/red-team/>red team</a>,&nbsp;<a href=/tags/network/>network</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>Back</a></span>&nbsp;|&nbsp;<span><a href=/>Home</a></span></section></div><div class=post-nav><a href=/how-to-setup-the-flipper-zero-for-wi-fi-attacks/ class=prev rel=prev title="How to setup the Flipper Zero for Wi-Fi attacks"><i class="fas fa-angle-left fa-fw" aria-hidden=true></i>How to setup the Flipper Zero for Wi-Fi attacks</a></div></div></article></div></main><footer class=footer><div class=footer-container><div class=footer-line itemscope itemtype=http://schema.org/CreativeWork><i class="far fa-copyright fa-fw" aria-hidden=true></i><span itemprop=copyrightYear>2023 - 2024</span><span class=author itemprop=copyrightHolder>&nbsp;<a href=/posts/ target=_blank>Anthares101</a></span></div></div></footer></div><div id=fixed-buttons><a href=# id=back-to-top class=fixed-button title="Back to Top"><i class="fas fa-arrow-up fa-fw" aria-hidden=true></i>
</a><a href=# id=view-comments class=fixed-button title="View Comments"><i class="fas fa-comment fa-fw" aria-hidden=true></i></a></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.css><script type=text/javascript src=https://cdn.jsdelivr.net/npm/autocomplete.js@0.38.1/dist/autocomplete.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lunr@2.3.9/lunr.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/lazysizes@5.3.2/lazysizes.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/clipboard@2.0.11/dist/clipboard.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/sharer.js@0.5.1/sharer.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/katex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/auto-render.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/copy-tex.min.js></script><script type=text/javascript src=https://cdn.jsdelivr.net/npm/katex@0.16.0/dist/contrib/mhchem.min.js></script><script type=text/javascript>window.config={code:{copyTitle:"Copy to clipboard",maxShownLines:50},comment:{},math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"}],strict:!1},search:{highlightTag:"em",lunrIndexURL:"/index.json",maxResultLength:10,noResultsFound:"No results found",snippetLength:30,type:"lunr"}}</script><script type=text/javascript src=/js/theme.min.js></script></body></html>